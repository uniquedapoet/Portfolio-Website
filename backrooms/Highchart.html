<!DOCTYPE html>
<html>
  <head>
    <title>Portfolio Value Chart with Treemap</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/treemap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- HTML for controls and Header -->
    <header>
        <nav>
          <h1>Tableau Profit Analysis</h1>
          <ul class="nav-links">
            <li><a href="index.html">Back To Portfolio</a></li>
          </ul>
        </nav>
      </header>
    <section>
      <div id="portfolio-chart" style="width: 100%; height: 600px"></div>
      <div id="controls">
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date" />
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date" />
        <button id="update-chart">Update Chart</button>
        <button id="reset-chart">Reset Stocks</button>
      </div>
    </section>
    <section>
      <div
        id="treemap-container"
        style="width: 100%; height: 600px; margin-top: 50px"
      ></div>
    </section>

    <script>
    // JavaScript for Highchart
      const csvFile = "data.csv";

    // initialize variables
      let parsedData = null;
      let stocks = {};
      let globalMinDate = null;
      let globalMaxDate = null;
      let globalMinValue = null;
      let globalMaxValue = null;

    //  function to calculate global ranges so the chart can be updated with
    //  new data without losing the original scale
      function calculateGlobalRanges(data) {
        const allDates = [];
        const allValues = [];

        data.forEach(stockData => {
          stockData.forEach(row => {
            const date = new Date(row.Date);
            const value = parseFloat(row.PortfolioValue);

            if (!isNaN(date) && !isNaN(value)) {
              allDates.push(date);
              allValues.push(value);
            }
          });
        });

        globalMinDate = new Date(Math.min(...allDates));
        globalMaxDate = new Date(Math.max(...allDates));
        globalMinValue = Math.min(...allValues);
        globalMaxValue = Math.max(...allValues);
      }

    // Final Portfolio Values for each stock
      const treemapData = [
        { name: "AMZN", value: 54705.79, sector: "Consumer Cyclical" },
        { name: "EL", value: 3314.78, sector: "Consumer Defensive" },
        { name: "JNJ", value: 15098.49, sector: "Healthcare" },
        { name: "MCD", value: 32722.79, sector: "Consumer Cyclical" },
        { name: "META", value: 40858.68, sector: "Communication Services" },
        { name: "PARA", value: 3500.76, sector: "Communication Services" },
        { name: "PAYC", value: 64480.13, sector: "Technology" },
        { name: "PG", value: 22187.0, sector: "Consumer Defensive" },
        { name: "TGT", value: 20765.52, sector: "Consumer Defensive" },
        { name: "WMT", value: 33005.53, sector: "Consumer Defensive" },
      ];
    // function to convert the treemap data into hierarchical data
    // so that the treemap can be displayed correctly with Sectors as 
    // parent nodes and Stocks as child nodes
      const hierarchicalData = treemapData.reduce((acc, item) => {
        const sectorIndex = acc.findIndex(group => group.id === item.sector);
        if (sectorIndex === -1) {
          acc.push({
            id: item.sector,
            name: item.sector,
            color: Highcharts.getOptions().colors[acc.length + 1],
          });
        }
        acc.push({
          parent: item.sector,
          name: item.name,
          value: item.value,
        });
        return acc;
      }, []);

      // function to filter data by date and stock
      function filterDataByDateAndStock(startDate, endDate, selectedStock = "all") {
        const filteredStocks = {};
        Object.keys(stocks).forEach(stockName => {
          if (selectedStock !== "all" && stockName !== selectedStock) return;

          filteredStocks[stockName] = stocks[stockName].filter(row => {
            const rowDate = new Date(row.Date);
            return (
              (!startDate || rowDate >= startDate) &&
              (!endDate || rowDate <= endDate)
            );
          });
        });
        return filteredStocks;
      }

      // function to update the chart with filtered data
      function updateChart(filteredStocks) {
        const seriesData = [];
        Object.keys(filteredStocks).forEach(stockName => {
          const stockData = filteredStocks[stockName];
          seriesData.push({
            name: stockName,
            data: stockData.map(row => parseFloat(row.PortfolioValue)),
          });
        });

      // Highchart for Portfolio Value Stocks
        Highcharts.chart("portfolio-chart", {
          chart: { type: "line" },
          title: { text: "Portfolio Value Stocks" },
          xAxis: {
            title: { text: "Date" },
            // Get the dates from the first stock in the filteredStocks object
            categories:
              Object.values(filteredStocks)[0]?.map(row => row.Date) || [],
            labels: { rotation: 45 },
          },
          yAxis: {
            title: { text: "Portfolio Value ($)" },
            min: globalMinValue,
            max: globalMaxValue,
          },
          tooltip: { shared: false, crosshairs: true },
          series: seriesData,
        });
      }
      console.log(hierarchicalData);
     // Highchart for Portfolio Value Treemap by Sector
      function updateTreemap() {
        Highcharts.chart("treemap-container", {
          chart: { type: "treemap" },
          title: { text: "Portfolio Value Treemap by Sector" },
          series: [
            {
              type: "treemap",
              layoutAlgorithm: "squarified",
              levels: [
                {
                // Set up the parent nodes (sectors)
                  level: 1,
                  dataLabels: {
                    enabled: true,
                    align: "left",
                    verticalAlign: "top",
                    style: {
                      fontSize: "16px",
                      fontWeight: "bold",
                      textOutline: "none",
                    },
                    padding: 5,
                  },
                  borderWidth: 3,
                },
                {
                  level: 2,
                  dataLabels: {
                    enabled: true,
                    format: "{point.name}: ${point.value:.2f}",
                    style: { fontSize: "12px" },
                  },
                  borderWidth: 1,
                },
              ],
              data: hierarchicalData,
              events: {
                click: function (event) {
                  const stockName = event.point.name; // Get the stock name from the clicked point
                  if (stocks[stockName]) {
                    const filteredStocks = { [stockName]: stocks[stockName] }; // Filter only the clicked stock
                    updateChart(filteredStocks); // Update the portfolio chart with filtered data
                  }
                },
              },
            },
          ],
          tooltip: { pointFormat: "<b>{point.name}</b>: ${point.value:.2f}" },
        });
      }

      Papa.parse(csvFile, {
        download: true,
        header: true,
        complete: function (results) {
          parsedData = results.data;
          stocks = {};
          parsedData.forEach(row => {
            const stockName = row.StockName;
            if (!stocks[stockName]) stocks[stockName] = [];
            stocks[stockName].push(row);
          });

          calculateGlobalRanges(Object.values(stocks));
          updateChart(stocks);
          updateTreemap();
        },
      });

      document.getElementById("update-chart").addEventListener("click", () => {
        const startDateInput = document.getElementById("start-date").value;
        const endDateInput = document.getElementById("end-date").value;
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        const filteredStocks = filterDataByDateAndStock(startDate, endDate);
        updateChart(filteredStocks);
      });

      document.getElementById("reset-chart").addEventListener("click", () => {
        updateChart(stocks);
      });
    </script>
  </body>
</html>
